#!/bin/bash
set -e
set -x

eval "$(rbenv init -)"

export RUBY_CONFIGURE_OPTS=" \
  --enable-shared \
  --with-gcc=clang CXX=clang++ \
  --with-arch=x86_64 \
  --with-out-ext=tk,tk/* \
  --with-valgrind \
  --with-readline-dir=$(brew --prefix readline) \
  --with-openssl-dir=$(brew --prefix openssl)"

export optflags="-O0 -g"
export debugflags="-g"
export RUBY_CFLAGS="${optflags} ${debugflags}"
export CXXFLAGS="${optflags} ${debugflags}"
export MAKE_OPTS="-j4"
unset CC CXX

for TARGET_VERSION in $@; do
  rbenv install --keep $TARGET_VERSION

  export RBENV_VERSION=$TARGET_VERSION

  gem install bundler
#  gem install rails -v '~> 3.2.18'
#  gem install rails -v '~> 4.0.5'
#  gem install rails -v '~> 4.1.1'
#  gem install rails -v '~> 4.2.0'

  rbenv rehash
done
